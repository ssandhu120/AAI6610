name: CI/CD - Credit Default API

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  ci:
    name: CI - Train & Smoke Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model & run a single prediction (smoke test)
        run: |
          python - << 'EOF'
          from app import train_model, FEATURES
          import pandas as pd

          # Train the model (same logic used by the app at startup)
          model = train_model()

          # Simple, valid sample row
          sample = pd.DataFrame(
              [[20000, 2, 2, 1, 35,
                0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0,
                0, 0, 0, 0, 0, 0]],
              columns=FEATURES
          )

          # Just ensure this runs without error
          proba = model.predict_proba(sample)[0, 1]
          print("Smoke test OK, probability_of_default =", float(proba))
          EOF

  deploy:
    name: CD - Sync to Hugging Face Space
    runs-on: ubuntu-latest
    needs: ci   # <-- THIS forces deploy to wait for CI and only run if CI succeeds
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository (full history, not shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

      - name: Add Hugging Face Space remote
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git remote remove space || true
          git remote add space https://ssandhu20:${HF_TOKEN}@huggingface.co/spaces/ssandhu20/AAI6610

      - name: Push to Hugging Face Space
        run: |
          git push space HEAD:main --force
